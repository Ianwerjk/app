
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬äº’å‹•è¡Œç¨‹åœ°åœ– (Vercel å®‰å…¨ç‰ˆ)</title>
    <style>
        /* --- æ¨£å¼èˆ‡ä¹‹å‰ç›¸åŒï¼Œæ­¤è™•çœç•¥ä»¥ä¿æŒç°¡æ½” --- */
        html, body { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', 'Arial', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; overflow: hidden; }
        .main-container { display: flex; height: calc(100% - 80px); }
        #itinerary-column { flex: 1; min-width: 320px; padding: 20px; background-color: #f8f9fa; overflow-y: auto; border-right: 1px solid #dee2e6; }
        #itinerary-column h2 { margin-top: 0; color: #c62828; border-bottom: 2px solid #c62828; padding-bottom: 10px; }
        #itinerary-list { list-style-type: none; padding: 0; }
        #itinerary-list li { background-color: #fff; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .item-content { flex-grow: 1; }
        .item-title { font-weight: bold; font-size: 1.1em; color: #3f51b5; }
        .item-desc { font-size: 0.95em; color: #555; margin-top: 5px; }
        .item-desc .time { font-weight: bold; }
        .item-desc .note { color: #c62828; font-weight: bold;}
        .nav-link { flex-shrink: 0; margin-left: 15px; padding: 8px 12px; background-color: #007bff; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9em; font-weight: bold; transition: background-color 0.2s; }
        .nav-link:hover { background-color: #0056b3; }
        #map-column { flex: 2; }
        #map { height: 100%; width: 100%; background-color: #e0e0e0; }
        #map-error { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.9); padding: 20px 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; color: #c0392b; z-index: 10; }
        .info-window-nav-link { display: inline-block; margin-top: 8px; padding: 5px 10px; background-color: #007bff; color: white !important; text-decoration: none; border-radius: 5px; font-size: 0.9em; }
        #day-selector { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1); z-index: 5; display: flex; align-items: center; justify-content: center; padding: 0 10px; gap: 6px; overflow-x: auto; }
        .day-btn { background-color: #f0f0f0; border: 2px solid transparent; border-radius: 20px; padding: 10px 18px; font-size: 1em; font-weight: 500; color: #555; cursor: pointer; transition: all 0.25s ease-in-out; white-space: nowrap; flex-shrink: 0; }
        .day-btn:hover { background-color: #e0e0e0; transform: translateY(-2px); }
        .day-btn.active { background-color: #3f51b5; color: white; border-color: #303f9f; box-shadow: 0 2px 8px rgba(63, 81, 181, 0.4); }
        .ai-btn { background-color: #ffc107; color: #333; font-weight: bold; }
        .ai-btn:hover { background-color: #ffca28; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4); }
        .locate-btn { background-color: #17a2b8; color: white; font-weight: bold;}
        .locate-btn:hover { background-color: #138496; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background: #fff; padding: 25px 30px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #eee; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 1.5em; line-height: 1; cursor: pointer; color: #888; }
        .modal-content h2 { margin-top: 0; color: #3f51b5; }
        #ai-modal-body h3 { border-bottom: 2px solid #3f51b5; padding-bottom: 5px; margin-top: 20px; color: #333; }
        #ai-modal-body p { line-height: 1.8; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .main-container { flex-direction: column; height: calc(100% - 120px); } #itinerary-column { flex: 1; border-right: none; border-bottom: 1px solid #dee2e6; } #map-column { flex: 1; } #day-selector { height: auto; min-height: 80px; flex-wrap: wrap; padding: 10px; } }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="itinerary-column"><h2 id="day-title"></h2><ul id="itinerary-list"></ul></div>
        <div id="map-column"><div id="map"></div><div id="map-error"><p><strong>åœ°åœ–è¼‰å…¥å¤±æ•—</strong></p><p>è«‹ç¢ºèªæ‚¨çš„ API é‡‘é‘°å·²æ­£ç¢ºè¨­å®šã€‚</p></div></div>
    </div>
    <div id="day-selector">
        <button id="locate-me-btn" class="day-btn locate-btn">ğŸ“ å®šä½</button>
        <button id="ai-planner-btn" class="day-btn ai-btn">âœ¨ AI å»ºè­°å¸«</button>
    </div>
    <div id="ai-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            <h2>âœ¨ AI æ—…éŠè¦åŠƒå¸«å»ºè­°</h2>
            <div id="ai-modal-body"></div>
        </div>
    </div>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDa_R9hUSHNV1VZ9hld-s8kYeouCxVscmE&callback=initMap&language=zh-TW&region=JP"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let map; let markers = []; let userLocationMarker = null; let currentDay = 1;
        const itineraryData = { 1:[{lat:35.7733,lng:140.3864,title:'æˆç”°æ©Ÿå ´ (NRT)',description:'<span class="time">17:05</span> æŠµé”æ±äº¬ï¼<br><span class="time">18:30~</span> å…¥å¢ƒé ˜è¡Œæ'},{lat:35.7295,lng:139.7109,title:'æ± è¢‹æ ¼æ‹‰æ–¯éº—é£¯åº—',description:'<span class="time">æ™šä¸Š</span> å…¥ä½é£¯åº—ï¼Œé™„è¿‘ç”¨é¤æˆ–ä¼‘æ¯'}],2:[{lat:35.7022,lng:139.5701,title:'å‰ç¥¥å¯º',description:'<span class="time">09:30</span> å¾æ± è¢‹å‡ºç™¼'},{lat:35.6962,lng:139.5704,title:'ä¸‰é·¹ä¹‹æ£®å‰åœåŠ›ç¾è¡“é¤¨',description:'<span class="time">10:45~13:00</span> åƒè§€<span class="note">é ˆé ç´„</span>'},{lat:35.6994,lng:139.5761,title:'äº•ä¹‹é ­æ©è³œå…¬åœ’',description:'<span class="time">13:00~14:30</span> å…¬åœ’æ•£æ­¥èˆ‡åˆé¤'},{lat:35.662,lng:139.714,title:'æ ¹æ´¥ç¾è¡“é¤¨',description:'<span class="time">15:00~16:30</span> åƒè§€ç¾è¡“é¤¨'}],3:[{lat:35.6764,lng:139.6993,title:'æ˜æ²»ç¥å®®',description:'<span class="time">09:30~11:00</span> åƒæ‹œ & åŸå®¿æ•£ç­–'},{lat:35.6609,lng:139.738,title:'éº»å¸ƒå°ä¹‹ä¸˜',description:'<span class="time">14:00~17:00</span> é«”é©— TeamLab Borderless<span class="note">é ˆé ç´„</span>'},{lat:35.6909,lng:139.7004,title:'æ–°å®¿',description:'<span class="time">18:00~</span> é€›è¡—æ™šé¤'},{lat:35.6896,lng:139.692,title:'æ±äº¬éƒ½å»³å±•æœ›å°',description:'<span class="time">20:00~21:30</span> æ¬£è³å…è²»å¤œæ™¯'}],4:[{lat:35.6653,lng:139.771,title:'ç¯‰åœ°å ´å¤–å¸‚å ´',description:'<span class="time">07:30~11:30</span> äº«ç”¨æ—©é¤èˆ‡é€›è¡—'},{lat:35.671,lng:139.765,title:'éŠ€åº§',description:'<span class="time">11:30~14:00</span> éŠ€åº§é€›è¡—èˆ‡åˆé¤'},{lat:35.2494,lng:139.0245,title:'ç®±æ ¹å°æ¶Œåœ’ å¤©æ‚ ',description:'<span class="time">16:30</span> æŠµé”ç®±æ ¹ï¼Œå…¥ä½é£¯åº—äº«å—æº«æ³‰'}],5:[{lat:35.2482,lng:139.0494,title:'é›•åˆ»ä¹‹æ£®ç¾è¡“é¤¨',description:'<span class="time">ä¸Šåˆ</span> é£¯åº—æ—©é¤å¾Œåƒè§€'},{lat:35.2536,lng:139.055,title:'å¼·ç¾…å…¬åœ’',description:'<span class="time">ä¸Šåˆ</span> å¯é¸æ™¯é»'},{lat:35.263,lng:139.04,title:'Polaç¾è¡“é¤¨',description:'<span class="time">ä¸Šåˆ</span> å¯é¸æ™¯é»'},{lat:35.2045,lng:139.0267,title:'ç®±æ ¹ãƒ»èŠ¦ãƒæ¹– ã¯ãªã‚’ã‚Š',description:'<span class="time">ä¸‹åˆ</span> å…¥ä½æ–°é£¯åº—ï¼Œç¹¼çºŒäº«å—æº«æ³‰'}],6:[{lat:35.197,lng:139.019,title:'èŠ¦ä¹‹æ¹–',description:'<span class="time">ä¸Šåˆ</span> é£¯åº—æ—©é¤å¾Œæ¹–é‚Šæ•£ç­–'},{lat:35.3377,lng:138.931,title:'Hotel Clad å¾¡æ®¿å ´',description:'<span class="time">ä¸­åˆ</span> é€€æˆ¿å¾Œå‰å¾€å¾¡æ®¿å ´ä¸¦å…¥ä½'},{lat:35.335,lng:138.932,title:'å¾¡æ®¿å ´ Premium Outlets',description:'<span class="time">ä¸‹åˆ/å‚æ™š</span> è³¼ç‰©ä¸­å¿ƒè¡€æ‹š'}],7:[{lat:35.7295,lng:139.7109,title:'æ± è¢‹æ ¼æ‹‰æ–¯éº—é£¯åº—',description:'<span class="time">ä¸‹åˆ</span> å¾å¾¡æ®¿å ´è¿”å›æ±äº¬ï¼Œå†æ¬¡å…¥ä½'},{lat:35.7289,lng:139.719,title:'æ± è¢‹å¤ªé™½åŸ',description:'<span class="time">å‚æ™š</span> å‘¨é‚Šè¼•é¬†æ´»å‹•'}],8:[{lat:35.7148,lng:139.7967,title:'æ·ºè‰å¯º',description:'<span class="time">09:30~11:00</span> åƒæ‹œ & ä»²è¦‹ä¸–é€šæ•£ç­–'},{lat:35.7142,lng:139.7739,title:'ä¸Šé‡å…¬åœ’',description:'<span class="time">11:30~13:30</span> å…¬åœ’æ•£æ­¥ï¼Œè‡ªç”±åƒè§€åšç‰©é¤¨æˆ–å‹•ç‰©åœ’'},{lat:35.659,lng:139.703,title:'Shibuya Sky (æ¾€è°·å¤©ç©º)',description:'<span class="time">16:00~18:00</span> åƒè§€èˆ‡å‘¨é‚Šé€›è¡—<span class="note">å»ºè­°é ç´„</span>'}],9:[{lat:35.6909,lng:139.7004,title:'æ–°å®¿',description:'<span class="time">å…¨æ—¥</span> æœ€å¾Œè¡åˆºï¼Œé€›è¡—è³¼ç‰©'},{lat:35.671,lng:139.765,title:'éŠ€åº§',description:'<span class="time">å…¨æ—¥</span> å“åšç¾é£Ÿæˆ–æ¢ç´¢æœªè¨ªåº—å®¶'}],10:[{lat:35.7295,lng:139.7109,title:'æ± è¢‹',description:'<span class="time">ä¸Šåˆ</span> è³¼è²·ä¼´æ‰‹ç¦®ã€æ•´ç†è¡Œæ'},{lat:35.7733,lng:140.3864,title:'æˆç”°æ©Ÿå ´ (NRT)',description:'<span class="time">16:30</span> å¾æ± è¢‹å‡ºç™¼å‰å¾€æ©Ÿå ´<br><span class="time">18:10</span> æ­æ©Ÿè¿”å›å°ç£ï¼'}]};
        function initMap() {
            window.gm_authFailure = () => { document.getElementById('map-error').style.display = 'block'; };
            map = new google.maps.Map(document.getElementById('map'), { center: { lat: 35.6895, lng: 139.6917 }, zoom: 11, mapTypeControl: false, streetViewControl: false, fullscreenControl: false, styles: [ { "featureType": "poi.business", "stylers": [{ "visibility": "off" }] }, { "featureType": "poi.park", "elementType": "labels.text", "stylers": [{ "visibility": "off" }] } ] });
            const daySelector = document.getElementById('day-selector');
            const aiButton = document.getElementById('ai-planner-btn');
            for (let day = 1; day <= 10; day++) {
                const button = document.createElement('button');
                button.className = 'day-btn';
                button.textContent = `ç¬¬ ${day} å¤©`;
                button.dataset.day = day;
                button.addEventListener('click', () => { displayDay(day); document.querySelectorAll('#day-selector .day-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); });
                daySelector.insertBefore(button, aiButton);
            }
            document.getElementById('locate-me-btn').addEventListener('click', locateUser);
            displayDay(1);
            daySelector.querySelector('.day-btn').classList.add('active');
            setupAiModal();
        }
        function displayDay(day) { currentDay = day; updateMapMarkers(day); updateItineraryText(day); }
        function updateItineraryText(day) {
            const titleEl = document.getElementById('day-title'); const listEl = document.getElementById('itinerary-list'); const locations = itineraryData[day];
            titleEl.textContent = `ç¬¬ ${day} å¤©è¡Œç¨‹`; listEl.innerHTML = '';
            if (!locations || locations.length === 0) { listEl.innerHTML = '<li>æœ¬æ—¥ç„¡è¡Œç¨‹è³‡æ–™ã€‚</li>'; return; }
            locations.forEach(location => {
                const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}`;
                const listItem = document.createElement('li');
                listItem.innerHTML = `<div class="item-content"><div class="item-title">${location.title}</div><div class="item-desc">${location.description}</div></div><a href="${navUrl}" target="_blank" class="nav-link">å°èˆª</a>`;
                listEl.appendChild(listItem);
            });
        }
        function updateMapMarkers(day) {
            markers.forEach(marker => marker.setMap(null)); markers = [];
            const locations = itineraryData[day]; if (!locations || locations.length === 0) return;
            const bounds = new google.maps.LatLngBounds(); const infoWindow = new google.maps.InfoWindow();
            locations.forEach(location => {
                const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}`;
                const marker = new google.maps.Marker({ position: { lat: location.lat, lng: location.lng }, map: map, title: location.title, animation: google.maps.Animation.DROP });
                markers.push(marker);
                marker.addListener('click', () => { const content = `<strong>${location.title}</strong><br><a href="${navUrl}" target="_blank" class="info-window-nav-link">é»æ­¤å°èˆª</a>`; infoWindow.setContent(content); infoWindow.open(map, marker); });
                bounds.extend(marker.getPosition());
            });
            if (locations.length > 1) { map.fitBounds(bounds); } else { map.setCenter(bounds.getCenter()); map.setZoom(14); }
        }
        function locateUser() {
            if (!navigator.geolocation) { alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚'); return; }
            navigator.geolocation.getCurrentPosition(position => {
                const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
                if (userLocationMarker) { userLocationMarker.setPosition(userPos); } else { userLocationMarker = new google.maps.Marker({ position: userPos, map: map, title: 'æ‚¨çš„ä½ç½®', icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2, } }); }
                map.setCenter(userPos); map.setZoom(15);
            }, () => { alert('ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªæ‚¨å·²æˆæ¬Šç€è¦½å™¨è®€å–ä½ç½®è³‡è¨Šã€‚'); });
        }
        function setupAiModal() {
            const aiButton = document.getElementById('ai-planner-btn'); const modal = document.getElementById('ai-modal'); const closeBtn = document.getElementById('modal-close-btn');
            aiButton.addEventListener('click', getAiSuggestions);
            closeBtn.addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => { if (e.target === modal) { modal.classList.remove('show'); } });
        }
        async function getAiSuggestions() {
            const modal = document.getElementById('ai-modal'); const modalBody = document.getElementById('ai-modal-body');
            modal.classList.add('show'); modalBody.innerHTML = '<div class="spinner"></div>';
            const dayLocations = itineraryData[currentDay];
            if (!dayLocations) { modalBody.innerHTML = '<p>ç•¶å‰æ—¥æœŸæ²’æœ‰è¡Œç¨‹è³‡æ–™ã€‚</p>'; return; }
            const itineraryList = dayLocations.map(loc => `- ${loc.title}`).join('\n');
            const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—¥æœ¬æ—…éŠå°ˆå®¶ã€‚æˆ‘æ­£åœ¨è¦åŠƒ2025å¹´çš„æ±äº¬è‡ªç”±è¡Œã€‚é€™æ˜¯ç¬¬ ${currentDay} å¤©çš„è¡Œç¨‹ï¼š\n${itineraryList}\n\nè«‹æ ¹æ“šä»¥ä¸Šè¡Œç¨‹ï¼Œç”¨ç¹é«”ä¸­æ–‡æä¾›ä»¥ä¸‹å»ºè­°ï¼Œä¸¦ä½¿ç”¨ Markdown æ ¼å¼åŒ–ä½ çš„å›ç­”ï¼š\n\n### ğŸ½ï¸ ç¾é£Ÿæ¨è–¦\næ ¹æ“šç•¶å¤©çš„åœ°é»å’Œæ™‚é–“ï¼Œæ¨è–¦ä¸€å®¶é©åˆçš„åˆé¤æˆ–æ™šé¤é¤å»³ã€‚è«‹èªªæ˜æ¨è–¦ç†ç”±å’Œå¤§æ¦‚çš„åƒ¹ä½ã€‚\n\n### âœ¨ æ½›åŠ›æ™¯é»\nåœ¨è¡Œç¨‹é™„è¿‘ï¼Œæ¨è–¦ä¸€å€‹é¡å¤–çš„å°æ™¯é»æˆ–æœ‰è¶£çš„åº—å®¶ï¼Œè®“è¡Œç¨‹æ›´è±å¯Œã€‚è«‹èªªæ˜å®ƒç‚ºä½•å€¼å¾—æ¢è¨ªã€‚\n\n### ğŸ’¡ è¶£å‘³å°çŸ¥è­˜\næŒ‘é¸ç•¶å¤©è¡Œç¨‹ä¸­çš„ä¸€å€‹ä¸»è¦æ™¯é»ï¼Œåˆ†äº«ä¸€å€‹è§€å…‰å®¢å¯èƒ½ä¸çŸ¥é“çš„æœ‰è¶£å°çŸ¥è­˜æˆ–æ­·å²æ•…äº‹ã€‚\n\nè«‹ç¢ºä¿ä½ çš„å›ç­”ç°¡æ½”ã€å¯¦ç”¨ä¸”å¸å¼•äººã€‚`;

            // *** é€™æ˜¯å‘¼å« Vercel å¾Œç«¯çš„é—œéµä¿®æ”¹ ***
            try {
                const response = await fetch('/api/getAiSuggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });
                if (!response.ok) { throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`); }
                const result = await response.json();
                if (result.error) { throw new Error(result.error); }
                const htmlResponse = result.text.replace(/### (.*)/g, '<h3>$1</h3>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                modalBody.innerHTML = htmlResponse;
            } catch (error) {
                console.error("AI å»ºè­°åŠŸèƒ½éŒ¯èª¤:", error);
                modalBody.innerHTML = `<p style="color: red;">æŠ±æ­‰ï¼ŒAI å»ºè­°åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚<br><small>éŒ¯èª¤è¨Šæ¯: ${error.message}</small></p>`;
            }
        }
    </script>
</body>
</html>

